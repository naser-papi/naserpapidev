{
  email {$EMAIL}
  # If you're testing certificates, uncomment the ACME staging CA:
  # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# Redirect www → apex
www.{$DOMAIN} {
  redir https://{$DOMAIN}{uri} permanent
}

# Main site
{$DOMAIN} {
  encode zstd gzip

  # Security headers (safe defaults)
  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
    Referrer-Policy "strict-origin-when-cross-origin"
    Permissions-Policy "camera=(), microphone=(), geolocation=()"
    -Server
  }

  # Long cache for static assets (Next.js)
  @immutableStatic {
    path /_next/static/* /favicon.ico /site.webmanifest /images/* /fonts/* /assets/*
  }
  header @immutableStatic Cache-Control "public, max-age=31536000, immutable"

  # Don’t cache APIs / admin
  @noCache path /api/* /admin/*
  header @noCache Cache-Control "no-store"

  # Reverse proxy to the app container
  reverse_proxy app:3000 {
    # Optional active health checks (requires your app to serve 200 on /api/health)
    health_uri /api/health
    health_interval 10s
    health_timeout 2s
    fail_duration 10s

    transport http {
      dial_timeout 5s
      response_header_timeout 30s
    }
    flush_interval -1
  }

  # Local health endpoint (only if you want Caddy to answer /health directly)
  @localHealth path /health
  respond @localHealth 200

  # Access logs (rotate in Caddy data volume)
  log {
    output file /data/caddy/access.log
    level INFO
  }
}
